name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: i686-pc-windows-msvc

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Rust dependencies (i686)
        uses: actions/cache@v4
        with:
          path: |
            capture-dll/target/i686-pc-windows-msvc/release
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-i686-${{ hashFiles('capture-dll/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-i686-

      - name: Cache Rust dependencies (x86_64)
        uses: actions/cache@v4
        with:
          path: |
            src-tauri/target/release
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-x64-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-x64-

      - name: Build 32-bit Capture DLL
        working-directory: capture-dll
        run: cargo build --release --target i686-pc-windows-msvc

      - name: Create Tauri target directory
        run: |
          if (!(Test-Path "src-tauri\target\release")) {
            New-Item -ItemType Directory -Force -Path "src-tauri\target\release"
          }
        shell: powershell

      - name: Copy DLL to Tauri target directory
        run: |
          Copy-Item "capture-dll\target\i686-pc-windows-msvc\release\capture_dll.dll" `
                    "src-tauri\target\release\capture_dll.dll"
        shell: powershell

      - name: Verify DLL exists
        run: |
          if (!(Test-Path "src-tauri\target\release\capture_dll.dll")) {
            Write-Error "capture_dll.dll not found in expected location!"
            exit 1
          }
          Write-Host "DLL successfully copied to: src-tauri\target\release\capture_dll.dll"
        shell: powershell

      - name: Install NPM dependencies
        run: npm ci

      - name: Build Tauri application
        run: npm run tauri build

      - name: Add UAC manifest to executable
        run: |
          # Use mt.exe to update the executable's manifest with UAC elevation
          $mtPath = (Get-Command mt.exe -ErrorAction SilentlyContinue).Path
          if (-not $mtPath) {
            # Find x64 mt.exe in Windows SDK
            $mtPath = Get-ChildItem "C:\Program Files (x86)\Windows Kits" -Recurse -Filter "mt.exe" -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -match '\\x64\\' } |
              Select-Object -First 1 -ExpandProperty FullName
          }
          if ($mtPath) {
            & $mtPath -manifest "src-tauri\app.manifest" -outputresource:"src-tauri\target\release\wow-packet-analyzer.exe;1"
            Write-Host "UAC manifest added successfully"
          } else {
            Write-Warning "mt.exe not found, executable may not have UAC elevation"
          }
        shell: powershell

      - name: Get version from tag
        id: get_version
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/(.*)') {
            $version = $matches[1]
          } else {
            $version = "dev-build"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Create release artifact
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $zipName = "WoW-Packet-Analyzer-$version-windows-x64.zip"

          # Create a temporary directory for artifacts
          New-Item -ItemType Directory -Force -Path "release-artifacts"

          # Copy standalone executable
          Copy-Item "src-tauri\target\release\wow-packet-analyzer.exe" "release-artifacts\"

          # Copy the DLL (required to be in same directory as exe)
          Copy-Item "src-tauri\target\release\capture_dll.dll" "release-artifacts\"

          # Create README for the release
          @"
          # WoW Packet Analyzer - Release $version

          ## Installation

          1. Extract all files from this archive to a folder
          2. Run wow-packet-analyzer.exe
          3. The application will request administrator privileges on first launch

          ## What's Included

          - wow-packet-analyzer.exe - Main application (standalone, no installation needed)
          - capture_dll.dll - 32-bit injection DLL (must be in same folder as .exe)

          ## System Requirements

          - Windows 10/11 (64-bit)
          - WebView2 Runtime (pre-installed on Windows 11, may need to be installed on Windows 10)
          - Administrator privileges required for packet capture functionality

          ## Notes

          This tool is for educational and development purposes only.
          Use responsibly and in accordance with Blizzard Entertainment's Terms of Service.

          ## Troubleshooting

          If the application fails to launch:
          - Ensure both .exe and .dll files are in the same folder
          - Install WebView2 Runtime: https://developer.microsoft.com/en-us/microsoft-edge/webview2/
          - Run as administrator
          "@ | Out-File -FilePath "release-artifacts\README.txt" -Encoding UTF8

          # Create the zip file
          Compress-Archive -Path "release-artifacts\*" -DestinationPath $zipName

          echo "ARTIFACT_NAME=$zipName" >> $env:GITHUB_OUTPUT
        id: create_artifact
        shell: powershell

      - name: Upload artifacts to workflow
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: ${{ steps.create_artifact.outputs.ARTIFACT_NAME }}

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.create_artifact.outputs.ARTIFACT_NAME }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
